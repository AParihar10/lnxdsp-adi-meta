From e3bc99e1589148a77ccf3692b4c7f3798498138a Mon Sep 17 00:00:00 2001
From: Nathan Barrett Morrison <nathan.morrison@timesys.com>
Date: Tue, 22 Oct 2019 08:57:13 -0400
Subject: [PATCH] Update initramfs boot sequence for Yocto

---
 include/configs/sc573-ezkit.h   |  1 +
 include/configs/sc584-ezkit.h   |  1 +
 include/configs/sc589-ezkit.h   |  1 +
 include/configs/sc589-mini.h    |  1 +
 include/configs/sc_adi_common.h | 16 ++++++++++++++--
 5 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/include/configs/sc573-ezkit.h b/include/configs/sc573-ezkit.h
index 9e7bcc4b2..e23d74f1a 100644
--- a/include/configs/sc573-ezkit.h
+++ b/include/configs/sc573-ezkit.h
@@ -167,6 +167,7 @@
 #define CONFIG_DWMMC
 #define CONFIG_BOUNCE_BUFFER
 
+#define INITRAMADDR "0x85000000"
 #include <configs/sc_adi_common.h>
 
 #endif
diff --git a/include/configs/sc584-ezkit.h b/include/configs/sc584-ezkit.h
index ce1df3748..cd0d26c79 100644
--- a/include/configs/sc584-ezkit.h
+++ b/include/configs/sc584-ezkit.h
@@ -158,6 +158,7 @@
 #define CONFIG_LINUX_MEMSIZE	"112M"
 #define CONFIG_CMD_BOOTZ
 
+#define INITRAMADDR "0x8C000000"
 #include <configs/sc_adi_common.h>
 
 #endif
diff --git a/include/configs/sc589-ezkit.h b/include/configs/sc589-ezkit.h
index fa05b6faa..24caa9510 100644
--- a/include/configs/sc589-ezkit.h
+++ b/include/configs/sc589-ezkit.h
@@ -186,6 +186,7 @@
 #define CONFIG_LINUX_MEMSIZE	"224M"
 #define CONFIG_CMD_BOOTZ
 
+#define INITRAMADDR "0xC5000000"
 #include <configs/sc_adi_common.h>
 
 #endif
diff --git a/include/configs/sc589-mini.h b/include/configs/sc589-mini.h
index ab349b164..c6318bb40 100644
--- a/include/configs/sc589-mini.h
+++ b/include/configs/sc589-mini.h
@@ -185,6 +185,7 @@
 #define CONFIG_LINUX_MEMSIZE	"224M"
 #define CONFIG_CMD_BOOTZ
 
+#define INITRAMADDR "0xC5000000"
 #include <configs/sc_adi_common.h>
 
 #endif
diff --git a/include/configs/sc_adi_common.h b/include/configs/sc_adi_common.h
index 7d54db004..35db7a7ca 100644
--- a/include/configs/sc_adi_common.h
+++ b/include/configs/sc_adi_common.h
@@ -116,6 +116,15 @@
 			__stringify(CONFIG_BAUDRATE) " "\
 	"mem=" CONFIG_LINUX_MEMSIZE
 
+#define CONFIG_BOOTARGS_RAMFS	\
+	"root=/dev/ram " \
+	"clkin_hz=" __stringify(CONFIG_CLKIN_HZ) " " \
+	CONFIG_BOOTARGS_VIDEO \
+	"earlyprintk=serial,uart0,57600 " \
+	"console=ttySC" __stringify(CONFIG_UART_CONSOLE) "," \
+			__stringify(CONFIG_BAUDRATE) " "\
+	"mem=" CONFIG_LINUX_MEMSIZE
+
 #define CONFIG_BOOTARGS_NFS	\
 	"root=/dev/nfs rw " \
 	"nfsroot=${serverip}:${rootpath},tcp,nfsvers=3 " \
@@ -165,15 +174,18 @@
 		"\0" \
 	\
 	"ramfile=zImage\0" \
+	"initramfile=ramdisk.cpio.xz.u-boot\0" \
+	"initramaddr=" INITRAMADDR "\0" \
 	"dtbfile=" CONFIG_DTBNAME "\0" \
 	"dtbaddr=" CONFIG_DTBLOADADDR "\0" \
-	"ramargs=set bootargs " CONFIG_BOOTARGS "\0" \
+	"ramargs=set bootargs " CONFIG_BOOTARGS_RAMFS "\0" \
 	"ramboot=" \
 		"tftp ${loadaddr} ${ramfile};" \
 		"tftp ${dtbaddr} ${dtbfile};" \
+		"tftp ${initramaddr} ${initramfile};" \
 		"run ramargs;" \
 		"run addip;" \
-		"bootz ${loadaddr} - ${dtbaddr}" \
+		"bootz ${loadaddr} ${initramaddr} ${dtbaddr}" \
 		"\0" \
 	\
 	"nfsfile=zImage\0" \
-- 
2.11.0

